** INSTALLATION

The installation of amusewiki takes time (depending on speed of the
machine and of the network) and requires about 5Gb of disk space
because of the full installation of TeXlive. If you're short on disk
space, don't even start to install (the app will create files at full
speed anyway, so consider 10Gb for a reasonable start).

On a slow server, it takes 2 hours (mostly spent on installing and
testing Perl modules, and 20 minutes to download and install the full
TeXlive 2015), but the procedure is fully automated, so start it,
check if it bails out at the beginning, forget about it for an hour or
two (run it under screen), then come back later and finish it up to
complete it for the operations which require root privileges (notably
the webserver configuration). The last lines of output is what
matters. It will tell you about the needed changes to the $PATH for
TeXlive, and where to login. From there you should be be able to
create and configure new sites from the admin console under
/admin/sites. [1]

The supported and recommended setup is nginx + FCGI. The FCGI setup
should work with Apache as well, but it's not currently actively
supported. perldoc Catalyst::Manual::Deployment::Apache::FastCGI
should help, though.

Prerequisites:

 - a database (mysql, pg, sqlite are supported)
 - a working perl (i.e., you can install modules)
 - fontconfig (install it before installing texlive)
 - graphicsmagick (for thumbnails) and imagemagick (for preview generation)
 - a mime-info database: shared-mime-info on debian
 - fcgiwrap running and listening to /var/run/fcgiwrap.socket (as in debian)
 - a dedicated system user (with a clean home) which is going to run the site

Log in as the user you want to run the site.

Unpack the sources (or clone the repo) and change directory into them.

Create a database for the application. E.g., for mysql:

  mysql> create database amuse DEFAULT CHARACTER SET utf8 DEFAULT COLLATE utf8_general_ci;
  mysql> grant all privileges on amuse.* to amuse@localhost identified by XXX

Or, for postgres:

Login as root.

 su - postgres
 psql
 create user amuse with password 'XXXX';
 create database amuse owner amuse;

For sqlite no setup is required.

Copy dbic.yaml.<dbtype>.example to dbic.yaml and adjust the
credentials, and chmod it to 600. (For sqlite is good as it is).

Please note that the installation procedure will create a mirror of
amusewiki.org under the subdomain amusewiki.<your domain>, where <your
domain> is the output of `hostname -d`. Nothing you can't change later
from the admin console, but you need to access it.

Execute:

./script/install.sh

The script is going to take care of the installation in a
non-interactive fashion, picking resonable defaults.

The output is copious, but you need only the last lines. Setting up
the $PATH in your bashrc (or equivalent) is crucial.

** USAGE

To start/stop/restart the application:

  ./init-all start
  ./init-all stop
  ./init-all restart

To regenerate the nginx configuration after adding a site:

  ./script/generate-nginx-conf.pl

(and read the output).


** OPTIONAL SETUP

Make the repositories read-only available via git-daemon.

  apt-get install git-daemon-sysvinit

Change /etc/default/git-daemon to read:

  GIT_DAEMON_ENABLE=true

Start the service

  service git-daemon start

Link the repositories in /var/cache/git (as per package documentation).
Note that in debian jessie it was moved to /var/lib/cache).

Something like this should do:

root@localhost:/var/cache/git# for i in ~amuse/amusewiki/repo/*; \
     do if [ -d "$i/.git" ]; then echo $(basename $i); \
     ln -s $i/.git $(basename $i).git ; fi ; done

And in your repo directory, mark the repository for export:

amuse@localhost:~/amusewiki/repo$ for i in */.git ; do touch $i/git-daemon-export-ok; done


** MULTIPLE INSTALLATIONS

If you run a Debian machine and you have only one instance running,
you don't need any of this.

Please note: "multiple instances" doesn't mean "multiple sites". On a
single instance you can have as many sites as you want.

Some environment variable you may want to use to address multiple
instance (say one for development and one for production), *before*
executing the install script:

# nginx log format, default to combined
export AMW_LOG_FORMAT=combined
# nginx root, default to Debian setup (/etc/nginx)
export AMW_NGINX_ROOT=/etc/nginx
# instance name, for nginx site files and ssl keys
export AMW_INSTANCE_NAME=amusewiki
# To set the number of FCGI workers, set the environment variable
# default to 3. E.g.
export AMW_WORKERS=5

You should put them in the bashrc as well, so if you need to
regenerate the webserver configuration when adding sites, you're
guaranteed to use the same settings.

Also, cgit will need to bind to a different port, so if 9015 is
already taken, create a  amusewikifarm_local.conf with this content:

<Model::CgitProxy>
    port 9099
</Model::CgitProxy>


** SYNTAX HIGHLIGHT

We ship a copy of highlight.js (https://highlightjs.org) to get an
optional syntax highlight for code blocks, with support for the
following languages: HTML, XML, Python, Bash, JS, Ruby, SQL, Diff,
JSON, Markdown, Perl, TeX.

If you want/need support for other languages, build your own copy on
https://highlightjs.org/download/ and install the script in

root/static/js/highlight/highlight.pack.local.js

and the CSS file in

root/static/js/highlight/style.local.css

If these files exist, the application will serve them instead of
the bundled ones.

[1] You can speed up the installation by installing most of the
required perl modules with your package manager, though. For TeX live
we check if xetex and xelatex are present in
$HOME/texlive/2015/bin/<arch> If you feel brave and in great need of
disk space, you can fool the installer by creating that dir and
symlinking xetex and xelatex there. But you're on your own if you're
missing latex pieces, fonts, etc. You have been warned.


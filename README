* AmuseWikiFarm

This is a wiki engine based on Emacs Muse markup with a Git backend.
It can work as a read-only site, as a moderated wiki, or as a fully
open wiki.

It strives to be simple and yet powerful enough for long-term
archiving of texts.

For requirement and installation, see INSTALL.txt

** Testing

DO NOT RUN make test IN THE LIVE DIRECTORY. If you want to run the
tests, do it in a dedicated checkout, as the tests leave a lot of
files behind.

** Users

We define 4 levels of users.

*** root permissions

The users with root permissions have full access to anything, but most
important, they can create new sites, change settings, add themes,
etc.. The same login works for all the sites. Given that being able to
access the templates means being able to inject code, this role should
be reserved to people that know what they are doing and have a shell
access.

*** librarian permissions

Every site can and should have one or more librarians with login. They
are able to access the revisions, approve the texts, etc. Special
pages are always reserved for them.

They can also create fellow librarians which will share the same
privileges. They are peers and they can create peers.

*** human permissions

This is not strictly speaking a role, because no login is required.
Anyway, to access some part of the sites (adding new texts, editing,
the bookbuilder), a prove that the user is a human and not a bot is
required. This is implemented via a question which the human has to
answer. It takes 10 seconds and after that the humanity of the user is
not questioned any more. Also, they should have cookies enabled
(otherwise we can't store a session for them).

*** robot permissions

Humans which don't prove to be such and robots can access all the
public part, including reading and download.

** Modes

Each site can run in one of these three modes, which differs on the
privileges granted to the humans.

*** private

Only logged in can access texts and the site.

*** blog

This mode restricts access to the text editing to librarians only.
Humans can still use the bookbuilder.

*** modwiki

This mode is a "moderated wiki". Humans can add new texts and edit
them, but approvals and publishing is reserved to the librarians.

*** openwiki

This mode is an "open wiki". Humans can add new texts, edit them, and
the result is published right away. Revisions are kept in the git, so
it's always possible to revert to a previous one (but could be
complicated and messy). Use at your own risk, but it could make sense
as a private wiki or in a LAN.

** Email notification

On commit emails are sent to the site.mail address, if any, with the
committer in CC, if he minded to leave one. If site.mail is not set
for the site, the whole mailing is skipped, including the notification
to the committer (as we assume we don't want to spam around).

** Templates and public directory:

 - root/static static files (css, js, images)

Deny the following in the webserver configuration:

 - root/themes theme files (override the templates with the same structure)
 - root/src    template directory.


** Local files (favicon.ico, navlogo.png, pagelogo.png, local.css, local.js)

These files may provide an override for cosmetics and features (via
js) without tampering the code. These files should be placed in the
site repository, under the directory site_files.

The navigation logo (navlogo.png) needs (and it's enforced to) an
height of 20px.

If pagelogo.png is present, it will be placed before the latest
entries on the special pages. The assigned ids are
"special-pages-logo" for the container and "special-pages-logo-img"
for the image itself.

** Local PO files

See LOCALIZATION.txt

** CONFIGURATION FILE

If amusewiki was installed with a package, the location is
/usr/share/perl5/AmuseWikiFarm/amusewikifarm.conf, otherwise is in the
application root.

Further configuration can be done creating a file called
amusewikifarm_local.conf in the same directory of the provided one, if
needed.

If amusewiki was installed with a package, the webserver root is
/usr/share/perl5/AmuseWikiFarm/root/, otherwise is "./root" in the
application directory.

** LET'S ENCRYPT

By default, during the installation a self-signed certificate is
created. This should be good enough to get you started.

You can set the path to the key and certificate in the admin console,
if you already have them.

If you don't have the certificate, you can request a free, valid, and
hassle-free certificate from Let's Encrypt, turning on the option in
the admin console.

Once enabled, the LE certificates will be checked by the amusewiki
daemon once a day, and renewed automatically if needed (a month before
the expiration). The problem is that you still have to reload the
webserver for the new certificates to pick up. If the logger is
sending you mail, you should see the warning.

Anyway, the debian package installs a cronjob in /etc/cron.daily to
reload nginx once a day to avoid the need to login and reload
manually. You should do the same. See debian/amusewiki.cron.daily


** MAIL WITH SMTP

Add this stanza to amusewikifarm_local.conf:

<Model::Mailer>
  mailer SMTP
 # these are Email::Sender::Transport::$mailer options
  <mailer_args>
    host     => 'my.smtp.host, # defaults to localhost
    sasl_username => 'mail',
    sasl_password => 'blabla',
  </mailer_args>
</Model::Mailer>

** EXPOSE THE GIT REPOSITORY WITH GIT-DAEMON

Make the repositories read-only available via git-daemon.

  apt-get install git-daemon-sysvinit

Change /etc/default/git-daemon to read:

  GIT_DAEMON_ENABLE=true

Start the service

  service git-daemon start

Link the repositories in /var/cache/git (as per package documentation).
Note that in debian jessie it was moved to /var/lib/cache).

Something like this should do, assuming the application root is /var/lib/amusewiki

 root@localhost:/var/cache/git# for i in /var/lib/amusewiki/repo/*; \
     do if [ -d "$i/.git" ]; then echo $(basename $i); \
     ln -s $i/.git $(basename $i).git ; fi ; done

And in your application directory, mark the repository for export:

  $ for i in repo/*/.git ; do touch $i/git-daemon-export-ok; done


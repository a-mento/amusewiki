#!/usr/bin/make -f
PACKAGE = $(shell dh_listpackages)
TMP     = $(CURDIR)/debian/$(PACKAGE)

%:
	dh $@ --with systemd

override_dh_systemd_enable:
	install -d $(TMP)/lib/systemd/system
	install -p -m644 $(CURDIR)/debian/amusewiki-cgit.service $(TMP)/lib/systemd/system/
	install -p -m644 $(CURDIR)/debian/amusewiki-web.service $(TMP)/lib/systemd/system/
	install -p -m644 $(CURDIR)/debian/amusewiki-jobber.service $(TMP)/lib/systemd/system/
	dh_systemd_enable

override_dh_testdir:
	$(CURDIR)/font-preview/gen.sh
	dh_testdir

# no parallel
override_dh_auto_build:
	dh_auto_build --max-parallel=1

# fix shebang and remove the use 'lib' stuff
override_dh_auto_install:
	dh_auto_install
	cat $(CURDIR)/debian/amusewiki-debian-config.conf > $(TMP)/usr/share/perl5/AmuseWikiFarm/amusewikifarm.conf
	sed -i '1s,^#!.*perl,#!/usr/bin/perl,' $(TMP)/usr/bin/amusewiki-*
	sed -i "/^use lib 'lib';/s/^/# /" $(TMP)/usr/bin/amusewiki-*
